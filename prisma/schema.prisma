generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String     @id @default(cuid())
  clerkId              String     @unique
  email                String     @unique
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  
  profile              Profile?
  hostedEvents         Event[]    @relation("EventHost")
  participations       EventParticipant[]
  sentInvitations      Invitation[] @relation("InvitationSender")
  receivedInvitations  Invitation[] @relation("InvitationReceiver")
  notifications        Notification[]
  locationSessions     LocationShareSession[]
  groupsHost           Group[]    @relation("GroupHost")
  groupMemberships     GroupMember[]
}

model Profile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  avatarUrl       String?
  favoriteSports  String[] 
  level           String?  // BEGINNER, INTERMEDIATE, ADVANCED
  city            String?
  bio             String?
  publicProfile   Boolean  @default(true)
  allowInvites    Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Sport {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  category    String?
  events      Event[]
}

model Event {
  id                  String             @id @default(cuid())
  hostId              String
  host                User               @relation("EventHost", fields: [hostId], references: [id])
  sportId             String
  sport               Sport              @relation(fields: [sportId], references: [id])
  title               String
  description         String?
  startsAt            DateTime
  endsAt              DateTime
  durationMinutes     Int?
  address             String?
  latitude            Float?
  longitude           Float?
  capacity            Int?
  type                String             @default("PUBLIC") // PUBLIC, PRIVATE, GROUP
  requireApproval     Boolean            @default(false)
  guestsCanInvite     Boolean            @default(true)
  locationVisibility  String             @default("CONFIRMED_ONLY") // CONFIRMED_ONLY, ALL, NONE
  status              String             @default("ACTIVE") // ACTIVE, CANCELLED, COMPLETED
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  participants        EventParticipant[]
  invitations         Invitation[]
  locationSessions    LocationShareSession[]
}

model EventParticipant {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("GOING") // GOING, DECLINED, WAITLIST, CANCELLED
  role      String   @default("MEMBER") // HOST, CO_HOST, MEMBER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
}

model Invitation {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User     @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("InvitationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status      String   @default("PENDING") // PENDING, ACCEPTED, DECLINED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([eventId, receiverId])
}

model Group {
  id          String        @id @default(cuid())
  name        String
  description String?
  hostId      String
  host        User          @relation("GroupHost", fields: [hostId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     GroupMember[]
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("MEMBER") // ADMIN, MEMBER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // INVITE_RECEIVED, INVITE_ACCEPTED, EVENT_CHANGED, REMINDER_1H, REMINDER_20M
  title     String
  body      String
  linkUrl   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LocationShareSession {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled   Boolean  @default(true)
  startedAt DateTime @default(now())
  endedAt   DateTime?

  pings     LocationPing[]

  @@unique([eventId, userId])
}

model LocationPing {
  id          String               @id @default(cuid())
  sessionId   String
  session     LocationShareSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  latitude    Float
  longitude   Float
  accuracy    Float?
  timestamp   DateTime             @default(now())
}
